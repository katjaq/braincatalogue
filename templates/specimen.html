<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title><!--SPECIMEN--></title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
	<link href='http://fonts.googleapis.com/css?family=Droid+Serif' rel='stylesheet' type='text/css'/>
	<link href='http://fonts.googleapis.com/css?family=Quicksand:400,300,100' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/lib/jquery-ui.css">
	<link rel="stylesheet" href="/css/common.css" type="text/css" media="screen, projection" />
	<link rel="stylesheet" href="/css/specimen.css" type="text/css" media="screen, projection" />
	<link rel="stylesheet" href="/css/atlasMaker+.css"/>
	<style>
		.ui-slider {height:2px}
		.ui-slider-handle {height:10px !important}
	</style>
</head>

<body>

<div id="wrapper">

	<!-- Header -->
	<header id="header">
		<div class="myinner">
			<div id="title" class="cell">
				<h1 style="display:inline-block">
					<a class="menu nodecoration" href="/" target="_top">
						<span class="bcicon">a</span>  Brain Catalogue
					</a>
				</h1>
			</div>
			<div id="menu" class="cell">
					<span id="MyLogin"></span>
					<span>
						<a class="menu" href="blog">Blog</a>
						<a class="menu" href="about.html">About</a>
						<a class="menu" href="http://siphonophore.org/blog/?cat=3&feed=rss2"><i class="fa fa-rss"></i></a>
					</span>
					<!--
					<a class="menu" href=#><i class="fa fa-user"></i></a>
					<a class="menu" href=#><i class="fa fa-search"></i></a>
					<a class="menu" href=#><i class="fa fa-bars"></i></a>
					-->
			</div>
		</div><!-- .myinner -->
	</header><!-- #header -->

	<section id="middle">
		<div id="container">
			<div id="content">
			
				<!-- 3.1.1 Picture -->
				<aside id="sideLeft">
					<div id="picture"></div>
				</aside><!-- #sideLeft -->

				<!-- 3.1.2 Name -->
				<div id="name"></div>
				<br>
				
				<!-- 3.1.3 Description -->
				<div id="description"></div>

				<!-- 3.1.4 Data -->
				<!--DATAVIEW-->
				<div id="data"></div>
				
				<!-- 3.1.5 Acknowledgments -->
				<p><div id="acknowledgements"></div>
			</div><!-- #content-->
		</div><!-- #container-->

	</section><!-- #middle-->

</div><!-- #wrapper -->

<div style="margin-bottom:100px;"></div>

<footer id="footer">
	<div>
		<table>
		<tr>
		<td>
		<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
		<img align="left" alt="Creative Commons License" src="/img/88x31.png" />
		</a>
		</td>
		<td>
		<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Brain Catalogue</span> by
		<a xmlns:cc="http://creativecommons.org/ns#" href="siphonophore.org/braincatalogue" property="cc:attributionName" rel="cc:attributionURL">Roberto Toro</a>
		is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
		</td>
		</tr>
		</table>
	</div>
</footer> <!-- footer -->

<script>
var specimen='<!--SPECIMEN-->';
var AtlasMaker=JSON.parse('<!--ATLAS-->');
</script>

<script src="/lib/jquery-1.11.0.min.js"></script>

<script>
// load stored description from wikipedia
$.getJSON('/data/'+specimen+'/info.txt',function(data)
{
	jQuery("div#test").append("[R]");

	// Load image
	jQuery("div#picture").html("<img class='picture' src='/data/"+specimen+"/picture.jpg'/>");

	// Load text
	var description=data.description.commonName;
	if(data.description.scientificName!=undefined)
		description+=" (<i>"+data.description.scientificName+"</i>)";
	jQuery("div#name").html("<h1>"+description+"</h1>");
	jQuery("div#description").html(data.description.description);
	if(data.description.acknowledgements) {
		jQuery("div#acknowledgements").append("<h2>ACKNOWLEDGEMENTS</h2>");
		jQuery("div#acknowledgements").append(data.description.acknowledgements);
	}
	jQuery("div#lastUpdated").html(data.description.lastUpdated);
	
});
</script>

<script src="/lib/jquery-ui-1.10.4.custom.min.js"></script>
<script src="/lib/jquery.ui.touch-punch.min.js"></script>
<script src="/lib/pako/pako.min.js"></script>
<script src="/lib/mylogin/login.js"></script>

<script>
var volume;
function loadScript(script) {
	var def=new $.Deferred();
	var s = document.createElement("script");
	s.src = script;
	s.onload=function(){console.log("loaded",script,new Date());def.resolve(s);}
	s.onerror=function(e){console.log("unable to load",script);def.reject(e);}
	document.body.appendChild(s);
	return def.promise();
}

function enterEditMode() {
	var black=$("<div id='blackOverlay'>");
	black.css({position:'fixed',top:0,left:0,width:'100%',height:'100%','z-index':5,'background-color':'black'});
	$('body').append(black);
	
	$("#atlasMaker").removeClass('display-mode');
	$("#atlasMaker").addClass('edit-mode');
	$("#atlasMaker").detach().appendTo('body');
	AtlasMakerWidget.editMode=1;
	
	var exit=$("<div>Close</div>");
	exit.css({position:'absolute',top:'5px',right:'5px',color:'white',fontFamily:'sans-serif',fontSize:'1rem'});
	exit.click(function(){exit.remove();exitEditMode();});
	$("#atlasMaker").append(exit);

	$("div#toolbar").draggable({containment:AtlasMakerWidget.container});
	$("div#toolbar").resizable({
		resize:function() {
			$("#log").outerHeight(
				$(this).height()
				-$("#controls").outerHeight(true)
				-$("label#chat").outerHeight(true)
				-$("#msg").outerHeight(true)
				-4
			)
		}
	});
}
function exitEditMode() {
	$("#blackOverlay").remove();
	
	$("#atlasMaker").removeClass('edit-mode');
	$("#atlasMaker").addClass('display-mode');
	$("#atlasMaker").detach().appendTo('#stereotaxic')	;
	AtlasMakerWidget.editMode=0;

	$("div#toolbar").draggable('destroy');
	$("div#toolbar").resizable('destroy');
	$("div#toolbar").css({top:0,left:0});
}

function checkURLExists(url) {
	console.log('checkurl',url);
	var def=$.Deferred();
	$.ajax({
		type: 'HEAD',
		url: url,
		success: function() {def.resolve()},
		error: function() {def.reject()}
	});
	return def.promise();
}
function selectAtlas(index) {
	console.log("> selectAtlas",index);
	AtlasMakerWidget.configureAtlasMaker(AtlasMaker[index]);
}

checkURLExists('/data/'+specimen+'/MRI-n4.nii.gz').then(function() {
	var s = document.createElement("script");
	s.src = "/js/atlasMaker.js";
	s.onload=function(){
		$("#data").append('<div id="stereotaxic"></div>');

		// Add MRI download link
		$("#stereotaxic").append("<a class='download_MRI download' href='/data/"+specimen+"/MRI-n4.nii.gz'></a>");
		AtlasMakerWidget.progress=$("#stereotaxic").find(".download_MRI");
		
		// Add Atlas edit and selection links
		$("#stereotaxic").append("<span class='edit_Atlas download'></span>");
		var i,html=[
			"<img src='/img/edit.svg' onclick='enterEditMode()' style='vertical-align:middle'/>",
			"<select style='margin-left:-8px;' onchange='selectAtlas(this.value)'>"
		];
		for(i=0;i<AtlasMaker.length;i++)
			html.push('	<option value='+i+'>'+AtlasMaker[i].description+'</option>');
		html.push('</select>');
		$("#stereotaxic").find(".edit_Atlas").append(html.join("\n"));
		
		// Add AtlasMaker
		$("#stereotaxic").append('<div id="atlasMaker"></div>');
		$("#atlasMaker").addClass('display-mode');
		AtlasMakerWidget.initAtlasMaker($("#atlasMaker"))
		.then(function() {
			AtlasMakerWidget.configureAtlasMaker(AtlasMaker[0]);
		});
	}
	document.body.appendChild(s);
});

checkURLExists('/data/'+specimen+'/mesh.ply').then(function() {
	loadScript("/lib/three.min.js")
	.then(function(){loadScript("/lib/TrackballControls.js")})
	.then(function(){loadScript("/lib/PLYLoader.js")})
	.then(function(){loadScript("/lib/CopyShader.js")})
	.then(function(){loadScript("/lib/SSAOShader.js")})
	.then(function(){loadScript("/lib/EffectComposer.js")})
	.then(function(){loadScript("/lib/RenderPass.js")})
	.then(function(){loadScript("/lib/MaskPass.js")})
	.then(function(){loadScript("/lib/ShaderPass.js")})
	.then(function() {
		var s = document.createElement("script");
		s.src = "/js/myMesh.js";
		s.onload=function(){
			console.log("ready to init mesh");

			$("#data").append([
				'<h2 class="Mesh"></h2>',
				'<div id="surface"></div>'
			].join("\n"));

			init_mesh(specimen,$("h2.Mesh"),$("#surface")[0]);
		}
		document.body.appendChild(s);
	});
});

MyLoginWidget.init($("#MyLogin"));

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-50078058-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
